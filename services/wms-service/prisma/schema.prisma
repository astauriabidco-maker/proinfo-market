generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== LEGACY ENUMS (v0) ==========

enum PickingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum AssemblyStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ShipmentStatus {
  READY
  SHIPPED
  DELIVERED
}

enum ReturnStatus {
  REQUESTED
  RECEIVED
  INSPECTED
}

// ========== SPRINT 17 — WMS AVANCÉ v1 ==========

enum TaskType {
  PICKING
  ASSEMBLY
  QA
  SHIPPING
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

// ========== LEGACY MODELS (v0) ==========

model PickingOrder {
  id        String        @id @default(uuid())
  assetId   String
  status    PickingStatus
  createdAt DateTime      @default(now())

  @@index([assetId])
  @@index([status])
}

model AssemblyOrder {
  id        String         @id @default(uuid())
  assetId   String
  tasks     Json
  status    AssemblyStatus
  createdAt DateTime       @default(now())

  @@index([assetId])
  @@index([status])
}

model Shipment {
  id          String         @id @default(uuid())
  assetId     String
  carrier     String
  trackingRef String?
  status      ShipmentStatus
  createdAt   DateTime       @default(now())

  @@index([assetId])
  @@index([status])
}

model Return {
  id        String       @id @default(uuid())
  assetId   String
  reason    String
  status    ReturnStatus
  createdAt DateTime     @default(now())

  @@index([assetId])
  @@index([status])
}

// ========== SPRINT 17 — OPERATOR & TASKS ==========

/// Opérateur WMS (magasinier, préparateur, contrôleur QA)
model Operator {
  id        String    @id @default(uuid())
  name      String
  badge     String    @unique
  createdAt DateTime  @default(now())
  tasks     WmsTask[]
}

/// Tâche WMS atomique (PICKING, ASSEMBLY, QA, SHIPPING)
/// Règle : 1 tâche = 1 asset = 1 opérateur = n étapes
model WmsTask {
  id         String     @id @default(uuid())
  assetId    String
  type       TaskType
  status     TaskStatus @default(PENDING)
  operatorId String?
  operator   Operator?  @relation(fields: [operatorId], references: [id])
  steps      TaskStep[]
  scans      ScanLog[]
  createdAt  DateTime   @default(now())
  startedAt  DateTime?
  endedAt    DateTime?

  @@index([assetId])
  @@index([status])
  @@index([operatorId])
  @@index([type, status])
}

/// Étape de tâche WMS avec scan obligatoire
/// Règle : Toutes les étapes doivent être complétées pour finaliser la tâche
model TaskStep {
  id           String   @id @default(uuid())
  taskId       String
  task         WmsTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  stepOrder    Int
  description  String
  scanRequired Boolean  @default(true)
  expectedCode String?
  scannedCode  String?
  completed    Boolean  @default(false)
  completedAt  DateTime?

  @@index([taskId])
  @@unique([taskId, stepOrder])
}

/// Log de scan pour traçabilité complète
/// Règle : Append-only, aucune modification
model ScanLog {
  id        String   @id @default(uuid())
  taskId    String
  task      WmsTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  stepId    String?
  code      String
  valid     Boolean
  scannedAt DateTime @default(now())

  @@index([taskId])
  @@index([scannedAt])
}

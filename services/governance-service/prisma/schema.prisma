generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Rôle organisationnel
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  level       Int      @default(0)  // 0=operator, 1=supervisor, 2=manager, 3=direction
  createdAt   DateTime @default(now())

  permissions RolePermission[]
  users       UserRole[]
}

/// Permission explicite
/// RÈGLE : Pas de permissions implicites
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique  // APPROVE_RMA, VALIDATE_PROCUREMENT, etc.
  description String?
  critical    Boolean  @default(false)  // Nécessite DecisionLog
  createdAt   DateTime @default(now())

  roles       RolePermission[]
  delegations Delegation[]
}

/// Association Role-Permission
model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
}

/// Association User-Role
model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  role Role @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
  @@index([userId])
}

/// Délégation temporaire
/// RÈGLE : Traçable, révocable, avec expiration
model Delegation {
  id           String    @id @default(uuid())
  fromUserId   String
  toUserId     String
  permissionId String
  reason       String?
  expiresAt    DateTime?
  revokedAt    DateTime?
  revokedBy    String?
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())

  permission Permission @relation(fields: [permissionId], references: [id])

  @@index([fromUserId])
  @@index([toUserId])
  @@index([expiresAt])
}

/// Journal des décisions humaines
/// RÈGLE : Append-only, jamais modifié
model DecisionLog {
  id          String   @id @default(uuid())
  actorId     String   // Qui
  actorName   String?  // Pour lisibilité
  action      String   // Quoi (APPROVE_RMA, VALIDATE_PROCUREMENT, etc.)
  entityType  String?  // Type d'entité concernée
  entityId    String?  // ID de l'entité
  context     String?  // JSON : pourquoi, détails
  delegatedBy String?  // Si action via délégation
  createdAt   DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

/// Événements de gouvernance
model GovernanceEvent {
  id        String   @id @default(uuid())
  eventType String   // PermissionGranted, DelegationExpired, etc.
  actorId   String
  targetId  String?
  data      String?
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([createdAt])
}
